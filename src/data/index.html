<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="HTTP server with custom methods, file upload, OPSEC mode, and HTML smuggling">
    <meta name="theme-color" content="#1a1a2e">
    <title>Experimental HTTP Server</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='0.9em' font-size='56'%3E%F0%9F%A7%AA%3C/text%3E%3C/svg%3E">
    <script src="/static/crypto-js.min.js" defer></script>
    <style>
        :root {
            --color-bg-primary: #1a1a2e;
            --color-bg-secondary: #16213e;
            --color-bg-surface: rgba(255, 255, 255, 0.05);
            --color-bg-input: #0d1117;
            --color-border: #30363d;
            --color-border-hover: rgba(255, 255, 255, 0.1);
            --color-text: #eee;
            --color-text-muted: #888;
            --color-text-dimmed: #8a8a8a;
            --color-text-code: #c9d1d9;
            --color-accent: #00d4ff;
            --color-accent-purple: #7b2cbf;
            --color-success: #4ade80;
            --color-warning: #facc15;
            --color-error: #f87171;
            --color-orange: #f97316;
            --color-indigo: #6366f1;
            --color-violet: #8b5cf6;
            --color-pink: #fb7185;
            --color-purple: #c084fc;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-pill: 20px;
            --radius-circle: 50%;
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        button, a, input, label {
            touch-action: manipulation;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 100%);
            color: var(--color-text);
            min-height: 100vh;
            padding: var(--spacing-lg);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 40px 0;
        }

        h1 {
            font-size: clamp(1.5rem, 5vw + 0.5rem, 2.5rem);
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .method-card {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-hover);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
        }


        .method-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .method-name.get { color: #4ade80; }
        .method-name.post { color: #facc15; }
        .method-name.fetch { color: #00d4ff; }
        .method-name.info { color: #c084fc; }
        .method-name.ping { color: #fb7185; }
        .method-name.none { color: #f97316; }
        .method-name.put { color: #38bdf8; }
        .method-name.patch { color: #a78bfa; }

        .method-desc {
            color: #aaa;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .demo-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-xl);
            min-height: 400px;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #00d4ff;
        }

        h3 {
            font-size: 1.2rem;
            margin: 20px 0 15px;
            color: #888;
        }

        .tab-content h2 {
            font-size: 1.2rem;
            color: #888;
        }

        .demo-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            cursor: pointer;
            transition: transform var(--transition-fast), opacity var(--transition-fast);
            font-weight: 500;
            min-height: 44px;
        }

        @media (hover: hover) {
            button:hover {
                transform: scale(1.05);
            }
        }

        button:focus-visible,
        input[type="text"]:focus-visible,
        input[type="password"]:focus-visible,
        input[type="checkbox"]:focus-visible,
        .upload-label:focus-visible {
            outline: 2px solid #00d4ff;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-get { background: #4ade80; color: #000; }
        .btn-post { background: #facc15; color: #000; }
        .btn-fetch { background: #00d4ff; color: #000; }
        .btn-info { background: #c084fc; color: #000; }
        .btn-ping { background: #fb7185; color: #000; }
        .btn-none { background: #f97316; color: #000; }
        .btn-put { background: #38bdf8; color: #000; }
        .btn-patch { background: #a78bfa; color: #000; }
        .btn-download { background: #6366f1; color: #fff; }

        .upload-method-btn { opacity: 0.5; }
        .upload-method-btn.active { opacity: 1; box-shadow: 0 0 0 2px var(--color-text); }

        .btn--sm { padding: 8px 12px; font-size: 0.85rem; }
        .btn--lg { padding: 14px 32px; font-size: 1.1rem; }

        .response-area {
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
        }

        .response-header {
            color: #7ee787;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }

        .response-body {
            color: #c9d1d9;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-bg-input);
            color: #fff;
            font-size: 1rem;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        footer {
            text-align: center;
            padding: 30px 0;
            color: #8a8a8a;
            font-size: 0.9rem;
        }

        .status, .file-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-pill);
            font-size: 0.85rem;
        }

        .status {
            margin-left: var(--spacing-sm);
        }

        .status.success, .file-status.success { background: rgba(74, 222, 128, 0.2); color: var(--color-success); }
        .status.error, .file-status.error { background: rgba(248, 113, 113, 0.2); color: var(--color-error); }

        /* Upload section */
        .upload-section {
            background: rgba(249, 115, 22, 0.1);
            border: 2px dashed #f97316;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: background var(--transition-normal), border-color var(--transition-normal);
        }

        .upload-section.dragover {
            background: rgba(249, 115, 22, 0.2);
            border-color: #fb923c;
        }

        .upload-section input[type="file"] {
            display: none;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            padding: 20px;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #aaa;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #8a8a8a;
            font-size: 0.85rem;
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-name {
            color: #fff;
            font-weight: 500;
        }

        .file-size {
            color: #888;
            font-size: 0.85rem;
        }

        .file-status.pending { background: rgba(250, 204, 21, 0.2); color: var(--color-warning); }
        .file-status.uploading { background: rgba(0, 212, 255, 0.2); color: var(--color-accent); }

        .uploaded-files {
            margin-top: 20px;
        }

        .uploaded-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(74, 222, 128, 0.1);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #30363d;
            color: #888;
            border-radius: 8px 8px 0 0;
            flex: 0 0 auto;
            white-space: nowrap;
        }

        .tab.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #30363d;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            transition: width 0.3s ease;
        }

        .method-btn {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .method-btn.active {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 0 10px currentColor;
        }

        .lang-switcher {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }

        .lang-btn {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-hover);
            border-radius: var(--radius-circle);
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .lang-btn:hover {
                transform: scale(1.1);
                border-color: var(--color-accent);
            }
        }

        .lang-btn.active {
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .telegram-link {
            color: #888;
            text-decoration: none;
            transition: color 0.2s ease;
            margin-top: 8px;
            display: inline-block;
        }

        @media (hover: hover) {
            .telegram-link:hover {
                color: var(--color-accent);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--color-bg-primary);
            padding: var(--spacing-xl);
            border-radius: var(--radius-md);
            max-width: 400px;
            width: 90%;
        }

        .modal-content h3 {
            color: var(--color-violet);
            margin-bottom: var(--spacing-md);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: bold;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--color-accent);
            vertical-align: middle;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Notepad */
        .notepad-container {
            display: flex;
            gap: 15px;
            min-height: 450px;
        }

        .notepad-sidebar {
            width: 240px;
            flex-shrink: 0;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            overflow-y: auto;
            max-height: 500px;
        }

        .notepad-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        .notepad-sidebar-header button {
            padding: 4px 10px;
            font-size: 0.8rem;
            min-height: 30px;
            background: var(--color-bg-surface);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border);
        }

        .note-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        @media (hover: hover) {
            .note-item:hover {
                background: var(--color-bg-surface);
            }
        }

        .note-item.active {
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid var(--color-accent);
        }

        .note-item-title {
            font-size: 0.9rem;
            color: var(--color-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-item-date {
            font-size: 0.75rem;
            color: var(--color-text-dimmed);
            margin-top: 3px;
        }

        .notepad-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
        }

        .notepad-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .notepad-toolbar input[type="text"] {
            flex: 1;
            min-width: 150px;
            padding: 10px 14px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-bg-input);
            color: #fff;
            font-size: 0.95rem;
        }

        .notepad-toolbar input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .notepad-textarea {
            flex: 1;
            width: 100%;
            min-height: 300px;
            padding: 14px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-bg-input);
            color: var(--color-text-code);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
        }

        .notepad-textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .notepad-textarea:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .notepad-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--color-text-dimmed);
            padding: 4px 0;
        }

        .save-indicator {
            display: inline-block;
            padding: 3px 10px;
            border-radius: var(--radius-pill);
            font-size: 0.8rem;
        }

        .save-indicator.saved { background: rgba(74, 222, 128, 0.15); color: var(--color-success); }
        .save-indicator.saving { background: rgba(0, 212, 255, 0.15); color: var(--color-accent); }
        .save-indicator.error { background: rgba(248, 113, 113, 0.15); color: var(--color-error); }
        .save-indicator.unsaved { background: rgba(250, 204, 21, 0.15); color: var(--color-warning); }

        .notepad-connection-status { transition: color 0.3s; }
        .notepad-connection-status.connected { color: var(--color-success); }
        .notepad-connection-status.connecting { color: var(--color-warning); }
        .notepad-connection-status.disconnected { color: var(--color-error); }
        .notepad-connection-status.no-encryption { color: var(--color-text-dimmed); }

        .notepad-no-notes {
            padding: 20px 12px;
            text-align: center;
            color: var(--color-text-dimmed);
            font-size: 0.85rem;
        }

        .btn-note { background: #10b981; color: #fff; }

        @media (max-width: 768px) {
            .notepad-container {
                flex-direction: column;
            }

            .notepad-sidebar {
                width: 100%;
                max-height: 200px;
            }

            body {
                padding: 12px;
            }

            .demo-section {
                padding: 20px;
            }

            header {
                padding: 20px 0;
            }


            .methods-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
                margin: 20px 0;
            }

            .method-card {
                padding: 12px;
            }
        }

        @media (max-width: 640px) {
            .tabs {
                gap: 6px;
                padding-bottom: 8px;
                margin-bottom: 16px;
                flex-wrap: wrap;
                overflow-x: visible;
            }

            .tab {
                padding: 10px 12px;
                font-size: 0.9rem;
                flex: 1 1 calc(50% - 6px);
                text-align: center;
                white-space: normal;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .demo-section {
                padding: 15px;
            }

            .subtitle {
                font-size: 0.95rem;
            }

            .methods-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .upload-section {
                padding: 20px 15px;
            }

            .input-group {
                flex-direction: column;
            }

            .input-group input[type="text"] {
                min-width: 0;
            }
        }

        @media (max-width: 360px) {
            body {
                padding: 6px;
            }

            .demo-section {
                padding: 12px;
            }

            .methods-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .method-card {
                padding: 10px;
            }

            .method-name {
                font-size: 1.1rem;
            }

            .method-desc {
                font-size: 0.8rem;
            }

            button {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Experimental HTTP Server</h1>
            <p class="subtitle" data-i18n="subtitle">HTTP-—Å–µ—Ä–≤–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤</p>
            <div class="lang-switcher">
                <button class="lang-btn active" onclick="setLang('ru')" id="langRu" title="–†—É—Å—Å–∫–∏–π">üá∑üá∫</button>
                <button class="lang-btn" onclick="setLang('en')" id="langEn" title="English">üá∫üá∏</button>
            </div>
            <p class="subtitle" id="sandboxIndicator" style="display: none; color: #f97316; margin-top: 10px; font-weight: bold;" data-i18n="sandboxMode">
                üîí SANDBOX MODE - –¥–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–∞–ø–∫–æ–π uploads/
            </p>
        </header>

        <section class="methods-grid">
            <div class="method-card">
                <div class="method-name get">GET</div>
                <p class="method-desc" data-i18n="methodGet">–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤</p>
            </div>
            <div class="method-card">
                <div class="method-name post">POST</div>
                <p class="method-desc" data-i18n="methodPost">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
            <div class="method-card">
                <div class="method-name fetch">FETCH</div>
                <p class="method-desc" data-i18n="methodFetch">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</p>
            </div>
            <div class="method-card">
                <div class="method-name info">INFO</div>
                <p class="method-desc" data-i18n="methodInfo">–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞</p>
            </div>
            <div class="method-card">
                <div class="method-name ping">PING</div>
                <p class="method-desc" data-i18n="methodPing">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</p>
            </div>
            <div class="method-card">
                <div class="method-name none">NONE</div>
                <p class="method-desc" data-i18n="methodNone">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</p>
            </div>
            <div class="method-card">
                <div class="method-name put">PUT</div>
                <p class="method-desc" data-i18n="methodPut">–ó–∞–≥—Ä—É–∑–∫–∞/–∑–∞–º–µ–Ω–∞</p>
            </div>
            <div class="method-card">
                <div class="method-name patch">PATCH</div>
                <p class="method-desc" data-i18n="methodPatch">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</p>
            </div>
        </section>

        <main>
        <section class="demo-section">
            <div class="tabs" role="tablist" aria-label="Server features">
                <button class="tab active" role="tab" aria-selected="true" aria-controls="requests-tab" id="tab-requests" onclick="switchTab('requests', this)" data-i18n="tabRequests">–ó–∞–ø—Ä–æ—Å—ã</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="upload-tab" id="tab-upload" onclick="switchTab('upload', this)" data-i18n="tabUpload">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="opsec-tab" id="tab-opsec" onclick="switchTab('opsec', this)" data-i18n="tabOpsec">OPSEC Mode</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="files-tab" id="tab-files" onclick="switchTab('files', this)" data-i18n="tabFiles">–§–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="notepad-tab" id="tab-notepad" onclick="switchTab('notepad', this)" data-i18n="tabNotepad">Secure Notepad</button>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ -->
            <div id="requests-tab" class="tab-content active" role="tabpanel" aria-labelledby="tab-requests">
                <h2 data-i18n="sendRequests">–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</h2>

                <div class="input-group">
                    <label for="pathInput" class="sr-only" data-i18n="labelFilePath">–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É</label>
                    <input type="text" id="pathInput" data-i18n-placeholder="pathPlaceholder" placeholder="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: /index.html)" value="/index.html">
                </div>

                <div class="demo-buttons">
                    <button class="btn-get" onclick="sendRequest('GET')">GET</button>
                    <button class="btn-fetch" onclick="sendRequest('FETCH')">FETCH</button>
                    <button class="btn-info" onclick="sendRequest('INFO')">INFO</button>
                    <button class="btn-ping" onclick="sendRequest('PING')">PING</button>
                </div>

                <div class="response-area" id="responseArea" aria-live="polite" data-testid="response-area">
                    <div class="response-header" data-i18n="clickToSend">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞...</div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="upload-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-upload">
                <h2 data-i18n="uploadFiles">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>

                <div class="demo-buttons" style="margin-bottom: 12px;">
                    <button class="btn-post upload-method-btn active" onclick="setUploadMethod('POST', this)">POST</button>
                    <button class="btn-none upload-method-btn" onclick="setUploadMethod('NONE', this)">NONE</button>
                    <button class="btn-put upload-method-btn" onclick="setUploadMethod('PUT', this)">PUT</button>
                    <button class="btn-patch upload-method-btn" onclick="setUploadMethod('PATCH', this)">PATCH</button>
                </div>

                <div class="upload-section" id="dropZone">
                    <label class="upload-label" for="fileInput">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text" data-i18n="dropFilesHere">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
                        <div class="upload-hint" id="uploadMethodHint">–ú–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏: POST</div>
                    </label>
                    <input type="file" id="fileInput" multiple>
                </div>

                <div class="file-list" id="fileList" data-testid="file-list"></div>

                <div class="demo-buttons" style="margin-top: 20px;">
                    <button class="btn-none" onclick="uploadAllFiles()" id="uploadBtn" disabled data-i18n="uploadAllBtn" data-testid="upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã</button>
                </div>

                <div class="response-area" id="uploadResponseArea" aria-live="polite" data-testid="upload-response-area">
                    <div class="response-header" data-i18n="selectFilesToUpload">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...</div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ OPSEC -->
            <div id="opsec-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-opsec">
                <h2 data-i18n="opsecTitle">OPSEC Mode - –°–∫—Ä—ã—Ç–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</h2>
                <p style="color: #888; margin-bottom: 20px;" data-i18n="opsecDesc">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∏–º–µ–Ω–∏ –≤ URL/–∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–µ HTTP –º–µ—Ç–æ–¥—ã.
                </p>
                <p id="opsecModeWarning" style="display: none; color: #f97316; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 0.9rem;" data-i18n="opsecWarning">
                    ‚ö† –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –±–µ–∑ —Ñ–ª–∞–≥–∞ --opsec. OPSEC-–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.
                </p>

                <div class="input-group">
                    <label for="opsecMethodInput" class="sr-only">HTTP Method</label>
                    <input type="text" id="opsecMethodInput" data-i18n-placeholder="opsecMethodPlaceholder" placeholder="HTTP –º–µ—Ç–æ–¥ (–ª—é–±–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: CHECKDATA)" value="">
                    <button class="btn-info" onclick="generateRandomMethod()" style="background: #6366f1;">Random</button>
                </div>

                <div class="upload-section" id="opsecDropZone" style="border-color: #6366f1; background: rgba(99, 102, 241, 0.1);">
                    <label class="upload-label" for="opsecFileInput">
                        <div class="upload-icon">üîí</div>
                        <div class="upload-text" data-i18n="opsecUploadText">OPSEC Upload - –∏–º—è —Ñ–∞–π–ª–∞ —Å–∫—Ä—ã—Ç–æ</div>
                        <div class="upload-hint" data-i18n="opsecUploadHint">–î–∞–Ω–Ω—ã–µ –∫–æ–¥–∏—Ä—É—é—Ç—Å—è –≤ base64, –ø—É—Ç—å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞</div>
                    </label>
                    <input type="file" id="opsecFileInput">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label style="color: #888; margin-right: 10px;">
                        <input type="checkbox" id="opsecIncludeName"> <span data-i18n="opsecIncludeName">–í–∫–ª—é—á–∏—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ (–º–µ–Ω–µ–µ —Å–∫—Ä—ã—Ç–Ω–æ)</span>
                    </label>
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label style="color: #888; margin-right: 10px;">
                        <input type="checkbox" id="opsecEncrypt"> <span data-i18n="opsecEncryptXor">–®–∏—Ñ—Ä–æ–≤–∞—Ç—å XOR</span>
                    </label>
                    <label for="opsecPassword" class="sr-only">XOR Password</label>
                    <input type="password" id="opsecPassword" data-i18n-placeholder="opsecPasswordPlaceholder" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è XOR-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è" style="flex: 1; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #fff;" disabled>
                </div>

                <div class="input-group" style="margin-top: 10px; margin-left: 25px;">
                    <label style="color: #8a8a8a; font-size: 0.9rem;">
                        <input type="checkbox" id="opsecSendKey"> <span data-i18n="opsecSendKey">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞)</span>
                    </label>
                </div>

                <div class="input-group" style="margin-top: 5px; margin-left: 45px;">
                    <label style="color: #8a8a8a; font-size: 0.85rem;">
                        <input type="checkbox" id="opsecKeyBase64" disabled> <span data-i18n="opsecKeyBase64">–ö–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –≤ Base64</span>
                    </label>
                </div>

                <div class="demo-buttons" style="margin-top: 20px;">
                    <button style="background: #6366f1; color: #fff;" onclick="opsecUpload()" id="opsecUploadBtn" disabled data-i18n="opsecUploadBtn" data-testid="opsec-upload-btn">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å (OPSEC)
                    </button>
                </div>

                <div class="response-area" id="opsecResponseArea" aria-live="polite" data-testid="opsec-response-area">
                    <div class="response-header" data-i18n="opsecSelectFile">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Å–∫—Ä—ã—Ç–æ–π –∑–∞–≥—Ä—É–∑–∫–∏...</div>
                </div>
            </div>

            <!-- Notepad tab -->
            <div id="notepad-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-notepad">
                <h2 data-i18n="notepadTitle">Secure Notepad</h2>
                <p style="color: #888; margin-bottom: 15px;" data-i18n="notepadDesc">
                    End-to-end encrypted notes. Encryption keys are negotiated automatically via ECDH ‚Äî no password needed.
                </p>

                <div class="notepad-toolbar">
                    <label for="notepadTitleInput" class="sr-only" data-i18n="notepadTitlePlaceholder">Note title</label>
                    <input type="text" id="notepadTitleInput" data-i18n-placeholder="notepadTitlePlaceholder" placeholder="Note title" maxlength="200" disabled>
                    <button class="btn-note btn--sm" onclick="notepadNewNote()" data-i18n="notepadNewBtn">New</button>
                    <button class="btn--sm" style="background: #f87171; color: #fff;" onclick="notepadDeleteNote()" id="notepadDeleteBtn" disabled data-i18n="notepadDeleteBtn">Delete</button>
                    <div class="transport-toggle" style="display: flex; align-items: center; gap: 8px; margin-left: auto; font-size: 0.85rem; color: var(--color-text-muted);">
                        <label style="display:flex;align-items:center;gap:3px;cursor:pointer;"><input type="radio" name="notepadTransport" value="http" checked> <span data-i18n="notepadTransportHttp">HTTP</span></label>
                        <label style="display:flex;align-items:center;gap:3px;cursor:pointer;"><input type="radio" name="notepadTransport" value="ws"> <span data-i18n="notepadTransportWs">WebSocket</span></label>
                        <span class="notepad-connection-status" id="notepadConnStatus" style="font-size:1.1em;" title="">&#9679;</span>
                    </div>
                </div>

                <div class="notepad-container" style="margin-top: 12px;">
                    <div class="notepad-sidebar">
                        <div class="notepad-sidebar-header">
                            <span data-i18n="notepadNotes">Notes</span>
                            <button onclick="notepadRefreshList()" title="Refresh">&#8635;</button>
                        </div>
                        <div id="notepadNoteList">
                            <div class="notepad-no-notes" data-i18n="notepadNoNotes">No notes yet</div>
                        </div>
                    </div>
                    <div class="notepad-editor">
                        <textarea class="notepad-textarea" id="notepadTextarea" data-i18n-placeholder="notepadTextareaPlaceholder" placeholder="Enter text here... (encrypted before saving)" disabled></textarea>
                        <div class="notepad-status-bar">
                            <span class="save-indicator" id="notepadSaveIndicator" data-i18n="notepadConnecting">Connecting...</span>
                            <span id="notepadCharCount">0 chars</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ —Ñ–∞–π–ª–æ–≤ -->
            <div id="files-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-files">
                <h2 data-i18n="serverFiles">–§–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</h2>

                <div class="input-group">
                    <button class="btn-fetch" onclick="goToRoot()" style="padding: 12px 16px;">/</button>
                    <button class="btn-ping" onclick="goUp()" style="padding: 12px 16px;">..</button>
                    <label for="browsePathInput" class="sr-only" data-i18n="labelDirPath">–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏</label>
                    <input type="text" id="browsePathInput" data-i18n-placeholder="dirPathPlaceholder" placeholder="–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏" value="/">
                    <button class="btn-info" onclick="browseDirectory()" data-i18n="browseBtn">–û–±–∑–æ—Ä (INFO)</button>
                </div>

                <div class="uploaded-files" id="serverFiles" data-testid="server-files"></div>

                <div class="response-area" id="filesResponseArea" aria-live="polite" data-testid="files-response-area">
                    <div class="response-header" data-i18n="clickBrowse">–ù–∞–∂–º–∏—Ç–µ "–û–±–∑–æ—Ä" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–æ–≤...</div>
                </div>
            </div>
        </section>
        </main>

        <footer>
            <p>Experimental HTTP Server v2.0</p>
            <a href="https://t.me/kgmnotes" target="_blank" rel="noopener" id="telegramLink" class="telegram-link">
                @kgmnotes
            </a>
        </footer>
    </div>

    <script>
        // ===== –°–∏—Å—Ç–µ–º–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ =====
        const translations = {
            ru: {
                subtitle: "HTTP-—Å–µ—Ä–≤–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤",
                sandboxMode: "üîí SANDBOX MODE - –¥–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–∞–ø–∫–æ–π uploads/",
                methodGet: "–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤",
                methodPost: "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",
                methodFetch: "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤",
                methodInfo: "–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞",
                methodPing: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
                methodNone: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤",
                methodPut: "–ó–∞–≥—Ä—É–∑–∫–∞/–∑–∞–º–µ–Ω–∞",
                methodPatch: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤",
                tabRequests: "–ó–∞–ø—Ä–æ—Å—ã",
                tabUpload: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤",
                tabFiles: "–§–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",
                tabOpsec: "OPSEC Mode",
                sendRequests: "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤",
                labelFilePath: "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É",
                labelDirPath: "–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏",
                pathPlaceholder: "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: /index.html)",
                uploadFiles: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤",
                methodLabel: "–ú–µ—Ç–æ–¥:",
                dropFilesHere: "–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞",
                uploadMethodLabel: "–ú–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏",
                uploadAllBtn: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã",
                serverFiles: "–§–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",
                dirPathPlaceholder: "–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏",
                browseBtn: "–û–±–∑–æ—Ä (INFO)",
                statusPending: "–û–∂–∏–¥–∞–Ω–∏–µ",
                statusUploading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                statusSuccess: "–ó–∞–≥—Ä—É–∂–µ–Ω",
                statusError: "–û—à–∏–±–∫–∞",
                clickToSend: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞...",
                selectFilesToUpload: "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...",
                clickBrowse: "–ù–∞–∂–º–∏—Ç–µ \"–û–±–∑–æ—Ä\" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–æ–≤...",
                uploadViaMethod: "–§–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥",
                networkError: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
                timeoutError: "–¢–∞–π–º-–∞—É—Ç ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è",
                parseError: "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞",
                error: "–û—à–∏–±–∫–∞",
                uploadStarting: "–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...",
                uploadComplete: "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                successCount: "—É—Å–ø–µ—à–Ω–æ",
                errorCount: "–æ—à–∏–±–æ–∫",
                sendingRequest: "–û—Ç–ø—Ä–∞–≤–∫–∞",
                requestTo: "–∑–∞–ø—Ä–æ—Å–∞ –Ω–∞",
                headers: "–ó–∞–≥–æ–ª–æ–≤–∫–∏",
                headersNA: "(–Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã)",
                responseBody: "–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞",
                time: "–í—Ä–µ–º—è",
                download: "–°–∫–∞—á–∞—Ç—å",
                loadingInfo: "–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ",
                open: "–û—Ç–∫—Ä—ã—Ç—å",
                opsecTitle: "OPSEC Mode - –°–∫—Ä—ã—Ç–∞—è –∑–∞–≥—Ä—É–∑–∫–∞",
                opsecDesc: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∏–º–µ–Ω–∏ –≤ URL/–∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–µ HTTP –º–µ—Ç–æ–¥—ã.",
                opsecMethodPlaceholder: "HTTP –º–µ—Ç–æ–¥ (–ª—é–±–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: CHECKDATA)",
                opsecUploadText: "OPSEC Upload - –∏–º—è —Ñ–∞–π–ª–∞ —Å–∫—Ä—ã—Ç–æ",
                opsecUploadHint: "–î–∞–Ω–Ω—ã–µ –∫–æ–¥–∏—Ä—É—é—Ç—Å—è –≤ base64, –ø—É—Ç—å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞",
                opsecIncludeName: "–í–∫–ª—é—á–∏—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ (–º–µ–Ω–µ–µ —Å–∫—Ä—ã—Ç–Ω–æ)",
                opsecEncryptXor: "–®–∏—Ñ—Ä–æ–≤–∞—Ç—å XOR",
                opsecPasswordPlaceholder: "–ü–∞—Ä–æ–ª—å –¥–ª—è XOR-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è",
                opsecSendKey: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞)",
                opsecKeyBase64: "–ö–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –≤ Base64",
                opsecUploadBtn: "–ó–∞–≥—Ä—É–∑–∏—Ç—å (OPSEC)",
                opsecSelectFile: "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Å–∫—Ä—ã—Ç–æ–π –∑–∞–≥—Ä—É–∑–∫–∏...",
                opsecFileSelected: "–§–∞–π–ª –≤—ã–±—Ä–∞–Ω",
                opsecPasswordRequired: "–û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è",
                opsecUploading: "–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥",
                opsecXorEncryption: "XOR —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ",
                opsecSuccess: "OPSEC Upload —É—Å–ø–µ—à–µ–Ω",
                opsecUploaded: "–ó–∞–≥—Ä—É–∂–µ–Ω–æ",
                opsecId: "ID",
                opsecSize: "–†–∞–∑–º–µ—Ä",
                opsecBytes: "–±–∞–π—Ç",
                opsecMethodRandom: "(—Å–ª—É—á–∞–π–Ω—ã–π)",
                opsecPathNoName: "(–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è —Ñ–∞–π–ª–∞)",
                opsecNameInReq: "–ò–º—è –≤ –∑–∞–ø—Ä–æ—Å–µ",
                opsecYes: "–¥–∞",
                opsecNoHidden: "–Ω–µ—Ç (—Å–∫—Ä—ã—Ç–æ)",
                opsecEncryption: "–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ",
                opsecNone: "–Ω–µ—Ç",
                opsecXorDecrypted: "XOR (—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",
                opsecKeyInBase64: ", –∫–ª—é—á –≤ base64",
                opsecXorEncrypted: "XOR (—Ñ–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω)",
                smuggleTitle: "HTML Smuggling",
                smuggleFile: "–§–∞–π–ª",
                smuggleProtect: "–ó–∞—â–∏—Ç–∏—Ç—å –ø–∞—Ä–æ–ª–µ–º (XOR)",
                smuggleProtectHint: "–ü–∞—Ä–æ–ª—å –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–µ—Ä–≤–µ—Ä–æ–º",
                smuggleOpen: "–û—Ç–∫—Ä—ã—Ç—å",
                smuggleCancel: "–û—Ç–º–µ–Ω–∞",
                smuggleGenerated: "HTML —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω",
                smuggleEncrypted: "–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω",
                smuggleYes: "–î–∞ (XOR)",
                smuggleNo: "–ù–µ—Ç",
                smuggleOpened: "HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.",
                opsecWarning: "‚ö† –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –±–µ–∑ —Ñ–ª–∞–≥–∞ --opsec. OPSEC-–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.",
                viewInFiles: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Ñ–∞–π–ª–∞—Ö ‚Üí",
                tabNotepad: "–ë–ª–æ–∫–Ω–æ—Ç",
                notepadTitle: "–ó–∞—â–∏—â—ë–Ω–Ω—ã–π –±–ª–æ–∫–Ω–æ—Ç",
                notepadDesc: "–°–∫–≤–æ–∑–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫. –ö–ª—é—á–∏ —Å–æ–≥–ª–∞—Å—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ ECDH ‚Äî –ø–∞—Ä–æ–ª—å –Ω–µ –Ω—É–∂–µ–Ω.",
                notepadTitlePlaceholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏",
                notepadTextareaPlaceholder: "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç... (—à–∏—Ñ—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º)",
                notepadNewBtn: "–ù–æ–≤–∞—è",
                notepadDeleteBtn: "–£–¥–∞–ª–∏—Ç—å",
                notepadNotes: "–ó–∞–º–µ—Ç–∫–∏",
                notepadNoNotes: "–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç",
                notepadConnecting: "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...",
                notepadConnected: "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ (E2E)",
                notepadDisconnected: "–û—Ç–∫–ª—é—á–µ–Ω–æ",
                notepadReady: "–ì–æ—Ç–æ–≤–æ",
                notepadUnsaved: "–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
                notepadSaving: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...",
                notepadSaved: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
                notepadLoading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                notepadLoaded: "–ó–∞–≥—Ä—É–∂–µ–Ω–æ",
                notepadSaveError: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",
                notepadLoadError: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",
                notepadDecryptError: "–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏",
                notepadSessionFailed: "–û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏",
                notepadNoEncryption: "–ë–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è",
                notepadTransportHttp: "HTTP",
                notepadTransportWs: "WebSocket",
                notepadEphemeralWarning: "–°–µ—Å—Å–∏–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞",
                notepadUntitled: "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
                notepadDeleteConfirm: "–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?"
            },
            en: {
                subtitle: "HTTP server with custom method support",
                sandboxMode: "üîí SANDBOX MODE - access limited to uploads/ folder",
                methodGet: "Get resources",
                methodPost: "Send data",
                methodFetch: "Download files",
                methodInfo: "File metadata",
                methodPing: "Server check",
                methodNone: "Upload files",
                methodPut: "Upload/replace",
                methodPatch: "Update files",
                tabRequests: "Requests",
                tabUpload: "File Upload",
                tabFiles: "Server Files",
                tabOpsec: "OPSEC Mode",
                sendRequests: "Send Requests",
                labelFilePath: "File path",
                labelDirPath: "Directory path",
                pathPlaceholder: "File path (e.g.: /index.html)",
                uploadFiles: "File Upload",
                methodLabel: "Method:",
                dropFilesHere: "Drag files here or click to select",
                uploadMethodLabel: "Upload method",
                uploadAllBtn: "Upload all files",
                serverFiles: "Server Files",
                dirPathPlaceholder: "Directory path",
                browseBtn: "Browse (INFO)",
                statusPending: "Pending",
                statusUploading: "Uploading...",
                statusSuccess: "Uploaded",
                statusError: "Error",
                clickToSend: "Click a button to send a request...",
                selectFilesToUpload: "Select files to upload...",
                clickBrowse: "Click \"Browse\" to view files...",
                uploadViaMethod: "Files will be uploaded via method",
                networkError: "Network error ‚Äî server unavailable",
                timeoutError: "Timeout ‚Äî request took too long",
                parseError: "Parse error",
                error: "Error",
                uploadStarting: "Starting upload...",
                uploadComplete: "Upload complete",
                successCount: "successful",
                errorCount: "errors",
                sendingRequest: "Sending",
                requestTo: "request to",
                headers: "Headers",
                headersNA: "(not available)",
                responseBody: "Response body",
                time: "Time",
                download: "Download",
                loadingInfo: "Loading info for",
                open: "Open",
                opsecTitle: "OPSEC Mode - Covert Upload",
                opsecDesc: "Upload files without revealing names in URL/headers. Random HTTP methods are used.",
                opsecMethodPlaceholder: "HTTP method (any, e.g.: CHECKDATA)",
                opsecUploadText: "OPSEC Upload - filename hidden",
                opsecUploadHint: "Data is base64-encoded, path does not contain filename",
                opsecIncludeName: "Include filename (less covert)",
                opsecEncryptXor: "Encrypt with XOR",
                opsecPasswordPlaceholder: "Password for XOR encryption",
                opsecSendKey: "Send key to server (auto-decrypt)",
                opsecKeyBase64: "Encode key in Base64",
                opsecUploadBtn: "Upload (OPSEC)",
                opsecSelectFile: "Select a file for covert upload...",
                opsecFileSelected: "File selected",
                opsecPasswordRequired: "Error: enter a password for encryption",
                opsecUploading: "Uploading via method",
                opsecXorEncryption: "XOR encryption",
                opsecSuccess: "OPSEC Upload successful",
                opsecUploaded: "Uploaded",
                opsecId: "ID",
                opsecSize: "Size",
                opsecBytes: "bytes",
                opsecMethodRandom: "(random)",
                opsecPathNoName: "(does not contain filename)",
                opsecNameInReq: "Name in request",
                opsecYes: "yes",
                opsecNoHidden: "no (hidden)",
                opsecEncryption: "Encryption",
                opsecNone: "none",
                opsecXorDecrypted: "XOR (decrypted on server",
                opsecKeyInBase64: ", key in base64",
                opsecXorEncrypted: "XOR (file encrypted)",
                smuggleTitle: "HTML Smuggling",
                smuggleFile: "File",
                smuggleProtect: "Protect with password (XOR)",
                smuggleProtectHint: "Password will be generated by server",
                smuggleOpen: "Open",
                smuggleCancel: "Cancel",
                smuggleGenerated: "HTML generated",
                smuggleEncrypted: "Encrypted",
                smuggleYes: "Yes (XOR)",
                smuggleNo: "No",
                smuggleOpened: "HTML page opened in new tab.",
                opsecWarning: "‚ö† Server started without --opsec flag. OPSEC upload may not work.",
                viewInFiles: "View in Files ‚Üí",
                tabNotepad: "Notepad",
                notepadTitle: "Secure Notepad",
                notepadDesc: "End-to-end encrypted notes. Encryption keys are negotiated automatically via ECDH ‚Äî no password needed.",
                notepadTitlePlaceholder: "Note title",
                notepadTextareaPlaceholder: "Enter text here... (encrypted before saving)",
                notepadNewBtn: "New",
                notepadDeleteBtn: "Delete",
                notepadNotes: "Notes",
                notepadNoNotes: "No notes yet",
                notepadConnecting: "Connecting...",
                notepadConnected: "Connected (E2E)",
                notepadDisconnected: "Disconnected",
                notepadReady: "Ready",
                notepadUnsaved: "Unsaved",
                notepadSaving: "Saving...",
                notepadSaved: "Saved",
                notepadLoading: "Loading...",
                notepadLoaded: "Loaded",
                notepadSaveError: "Save error",
                notepadLoadError: "Load error",
                notepadDecryptError: "Decrypt error",
                notepadSessionFailed: "Session failed",
                notepadNoEncryption: "No encryption",
                notepadTransportHttp: "HTTP",
                notepadTransportWs: "WebSocket",
                notepadEphemeralWarning: "Sessions are lost on server restart",
                notepadUntitled: "Untitled",
                notepadDeleteConfirm: "Delete this note?"
            }
        };

        let currentLang = localStorage.getItem('lang') || 'ru';

        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.documentElement.lang = lang;
            applyTranslations();
            updateLangButtons();
        }

        function applyTranslations() {
            const t = translations[currentLang];

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º placeholder'—ã
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–∏–Ω—Ç –º–µ—Ç–æ–¥–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            const hint = document.getElementById('uploadMethodHint');
            if (hint && t.uploadMethodLabel) {
                hint.textContent = t.uploadMethodLabel + ': ' + (typeof uploadMethod !== 'undefined' ? uploadMethod : 'POST');
            }
        }

        function updateLangButtons() {
            document.getElementById('langRu').classList.toggle('active', currentLang === 'ru');
            document.getElementById('langEn').classList.toggle('active', currentLang === 'en');
        }

        function t(key) {
            return translations[currentLang][key] || key;
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.lang = currentLang;
            applyTranslations();
            updateLangButtons();
        });

        // HTML escape helper (XSS prevention)
        function esc(str) {
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        // –ë–∞–∑–æ–≤—ã–π URL —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ —Å –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)
        const SERVER_URL = '';

        // –§–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        let filesToUpload = [];

        // Sandbox mode flag
        let isSandboxMode = false;
        let isOpsecMode = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function checkServerMode() {
            try {
                const response = await sendCustomRequest('PING', SERVER_URL + '/');
                const text = await response.text();
                const info = JSON.parse(text);

                if (info.sandbox_mode) {
                    isSandboxMode = true;
                    document.getElementById('sandboxIndicator').style.display = 'block';
                    document.getElementById('browsePathInput').value = '/';
                }

                if (info.opsec_mode) {
                    isOpsecMode = true;
                }

                // Show warning on OPSEC tab if server not in OPSEC mode
                if (!info.opsec_mode) {
                    const opsecWarning = document.getElementById('opsecModeWarning');
                    if (opsecWarning) opsecWarning.style.display = 'block';
                }
            } catch (e) {
                console.log('Could not check server mode:', e);
            }
        }

        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        checkServerMode();

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName, tabButton) {
            document.querySelectorAll('.tab[role="tab"]').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            if (tabButton) {
                tabButton.classList.add('active');
                tabButton.setAttribute('aria-selected', 'true');
            }
            document.getElementById(tabName + '-tab').classList.add('active');

            // Update URL hash
            history.replaceState(null, '', '#' + tabName);

            if (tabName === 'files') {
                setTimeout(browseDirectory, 100);
            }
            if (tabName === 'notepad') {
                notepadInit();
            }
        }

        // Restore tab from URL hash on load
        window.addEventListener('DOMContentLoaded', () => {
            const hash = location.hash.replace('#', '');
            if (hash && document.getElementById(hash + '-tab')) {
                const tabBtn = document.getElementById('tab-' + hash);
                if (tabBtn) switchTab(hash, tabBtn);
            }
        });

        // Arrow key navigation for tabs (WAI-ARIA tab pattern)
        document.querySelector('[role="tablist"]').addEventListener('keydown', (e) => {
            const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
            const currentIndex = tabs.indexOf(document.activeElement);
            if (currentIndex === -1) return;

            let newIndex;
            if (e.key === 'ArrowRight') {
                newIndex = (currentIndex + 1) % tabs.length;
            } else if (e.key === 'ArrowLeft') {
                newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
            } else if (e.key === 'Home') {
                newIndex = 0;
            } else if (e.key === 'End') {
                newIndex = tabs.length - 1;
            } else {
                return;
            }
            e.preventDefault();
            tabs[newIndex].focus();
            tabs[newIndex].click();
        });

        // ===== –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ =====
        async function sendRequest(method) {
            const path = document.getElementById('pathInput').value || '/';
            const responseArea = document.getElementById('responseArea');

            responseArea.innerHTML = `<div class="response-header">${t('sendingRequest')} ${esc(method)} ${t('requestTo')} ${esc(path)}...</div>`;

            try {
                const startTime = performance.now();

                const response = await sendCustomRequest(method, SERVER_URL + path, null);

                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                const text = await response.text();
                const statusClass = response.status < 400 ? 'success' : 'error';

                let headersText = '';
                for (const [key, value] of Object.entries(response.headers)) {
                    headersText += `${key}: ${value}\n`;
                }

                let bodyDisplay = text;
                try {
                    const json = JSON.parse(text);
                    bodyDisplay = JSON.stringify(json, null, 2);
                } catch (e) {
                    if (text.length > 500) {
                        bodyDisplay = text.substring(0, 500) + '\n... (truncated)';
                    }
                }

                responseArea.innerHTML = `
<div class="response-header">
${esc(method)} ${esc(path)}
<span class="status ${statusClass}">${response.status} ${esc(response.statusText || '')}</span>
${t('time')}: ${duration}ms
</div>
<div class="response-body">--- ${t('headers')} ---
${esc(headersText || t('headersNA'))}
--- ${t('responseBody')} ---
${esc(bodyDisplay)}</div>`;

                // –ï—Å–ª–∏ —ç—Ç–æ FETCH, –ø—Ä–µ–¥–ª–æ–∂–∏–º —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                if (method === 'FETCH' && response.status === 200) {
                    const filename = response.headers['x-file-name'] || 'download';
                    responseArea.innerHTML += `\n\n<button class="btn-download" onclick="downloadFile('${esc(path)}')">${t('download')} ${esc(filename)}</button>`;
                }

            } catch (error) {
                responseArea.innerHTML = `
<div class="response-header">
${esc(method)} ${esc(path)}
<span class="status error">${t('error')}</span>
</div>
<div class="response-body">${esc(error.message)}</div>`;
            }
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö HTTP-–º–µ—Ç–æ–¥–æ–≤
        function sendCustomRequest(method, path, body, headers = {}, onUploadProgress = null) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(method, path, true);
                xhr.timeout = 30000; // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

                if (onUploadProgress && xhr.upload) {
                    xhr.upload.onprogress = onUploadProgress;
                }

                for (const [key, value] of Object.entries(headers)) {
                    xhr.setRequestHeader(key, value);
                }

                xhr.onload = () => {
                    const responseHeaders = {};
                    xhr.getAllResponseHeaders().split('\r\n').forEach(line => {
                        const idx = line.indexOf(': ');
                        if (idx > 0) {
                            const key = line.substring(0, idx);
                            const value = line.substring(idx + 2);
                            responseHeaders[key.toLowerCase()] = value;
                        }
                    });
                    resolve({
                        status: xhr.status,
                        statusText: xhr.statusText,
                        headers: responseHeaders,
                        text: () => Promise.resolve(xhr.responseText),
                        blob: () => Promise.resolve(new Blob([xhr.response]))
                    });
                };

                xhr.onerror = () => reject(new Error(t('networkError')));
                xhr.ontimeout = () => reject(new Error(t('timeoutError')));

                if (body) {
                    xhr.send(body);
                } else if (method === 'POST') {
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify({ demo: true, timestamp: new Date().toISOString() }));
                } else {
                    xhr.send();
                }
            });
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ FETCH
        async function downloadFile(path) {
            const xhr = new XMLHttpRequest();
            xhr.open('FETCH', SERVER_URL + path, true);
            xhr.responseType = 'blob';

            xhr.onload = () => {
                const filename = xhr.getResponseHeader('X-File-Name') || 'download';
                const blob = xhr.response;
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            };

            xhr.send();
        }

        // ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ =====
        let uploadMethod = 'POST';

        function setUploadMethod(method, btn) {
            uploadMethod = method;
            document.querySelectorAll('.upload-method-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const hint = document.getElementById('uploadMethodHint');
            if (hint) hint.textContent = t('uploadMethodLabel') + ': ' + method;
        }

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            for (const file of files) {
                if (!filesToUpload.find(f => f.name === file.name && f.size === file.size)) {
                    filesToUpload.push({
                        file: file,
                        name: file.name,
                        size: file.size,
                        status: 'pending',
                        progress: 0
                    });
                }
            }
            renderFileList();
            uploadBtn.disabled = filesToUpload.length === 0;
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        let renderFileListRAF = null;
        function scheduleRenderFileList() {
            if (!renderFileListRAF) {
                renderFileListRAF = requestAnimationFrame(() => {
                    renderFileListRAF = null;
                    renderFileList();
                });
            }
        }

        function renderFileList() {
            fileList.innerHTML = filesToUpload.map((f, i) => `
                <div class="file-item" data-testid="file-item-${i}">
                    <div class="file-info">
                        <span class="file-name">${esc(f.name)}</span>
                        <span class="file-size">${formatSize(f.size)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="file-status ${f.status}">${getStatusText(f.status)}</span>
                        ${f.status === 'pending' ? `<button class="btn--sm" onclick="removeFile(${i})" style="background: #f87171; padding: 5px 10px;">‚úï</button>` : ''}
                    </div>
                </div>
                ${f.status === 'uploading' ? `<div class="progress-bar"><div class="progress-fill" style="width: ${f.progress || 0}%"></div></div>` : ''}
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': t('statusPending'),
                'uploading': t('statusUploading'),
                'success': t('statusSuccess'),
                'error': t('statusError')
            };
            return statusMap[status] || status;
        }

        function removeFile(index) {
            filesToUpload.splice(index, 1);
            renderFileList();
            uploadBtn.disabled = filesToUpload.length === 0;
        }

        async function uploadAllFiles() {
            const uploadResponseArea = document.getElementById('uploadResponseArea');
            uploadResponseArea.innerHTML = `<div class="response-header">${t('uploadStarting')}</div>`;
            uploadBtn.disabled = true;

            const results = [];

            for (let i = 0; i < filesToUpload.length; i++) {
                const fileData = filesToUpload[i];
                if (fileData.status !== 'pending') continue;

                fileData.status = 'uploading';
                fileData.progress = 0;
                renderFileList();

                try {
                    const arrayBuffer = await fileData.file.arrayBuffer();
                    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ ${fileData.name}, —Ä–∞–∑–º–µ—Ä: ${arrayBuffer.byteLength} –±–∞–π—Ç`);

                    // –ö–æ–¥–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
                    const encodedFileName = encodeURIComponent(fileData.name);

                    const response = await sendCustomRequest(
                        uploadMethod,
                        SERVER_URL + '/' + encodedFileName,
                        arrayBuffer,
                        {
                            'Content-Type': fileData.file.type || 'application/octet-stream',
                            'X-File-Name': encodedFileName
                        },
                        (event) => {
                            if (!event.lengthComputable) {
                                return;
                            }
                            fileData.progress = Math.round((event.loaded / event.total) * 100);
                            scheduleRenderFileList();
                        }
                    );

                    console.log(`–û—Ç–≤–µ—Ç: ${response.status}`, response);

                    const text = await response.text();
                    console.log(`–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞: ${text}`);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (parseError) {
                        result = { success: false, error: t('parseError') + ': ' + text.substring(0, 100) };
                    }

                    if ((response.status === 200 || response.status === 201) && result.success) {
                        fileData.status = 'success';
                        fileData.progress = 100;
                        fileData.serverPath = result.path;
                        results.push({ name: fileData.name, success: true, path: result.path });
                    } else {
                        fileData.status = 'error';
                        fileData.progress = 0;
                        results.push({ name: fileData.name, success: false, error: result.error || `HTTP ${response.status}` });
                    }
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${fileData.name}:`, error);
                    fileData.status = 'error';
                    fileData.progress = 0;
                    results.push({ name: fileData.name, success: false, error: error.message });
                }

                renderFileList();
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const successCount = results.filter(r => r.success).length;
            const failCount = results.filter(r => !r.success).length;

            uploadResponseArea.innerHTML = `
<div class="response-header">
${t('uploadComplete')}
<span class="status ${failCount === 0 ? 'success' : 'error'}">${successCount} ${t('successCount')}, ${failCount} ${t('errorCount')}</span>
</div>
<div class="response-body">${results.map(r =>
    r.success
        ? `‚úì ${esc(r.name)} -> ${esc(r.path)}`
        : `‚úó ${esc(r.name)}: ${esc(r.error)}`
).join('\n')}</div>
${successCount > 0 ? `<button class="btn-info btn--sm" onclick="switchTab('files', document.getElementById('tab-files'))" style="margin-top: 10px;">${t('viewInFiles')}</button>` : ''}`;

            // –û—á–∏—â–∞–µ–º —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            filesToUpload = filesToUpload.filter(f => f.status !== 'success');
            renderFileList();
            uploadBtn.disabled = filesToUpload.length === 0;
        }

        // ===== –û–±–∑–æ—Ä —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ =====
        function goToRoot() {
            document.getElementById('browsePathInput').value = '/';
            browseDirectory();
        }

        function goUp() {
            const pathInput = document.getElementById('browsePathInput');
            let path = pathInput.value || '/';

            // –£–±–∏—Ä–∞–µ–º trailing slash –µ—Å–ª–∏ –µ—Å—Ç—å
            if (path.endsWith('/') && path.length > 1) {
                path = path.slice(0, -1);
            }

            // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            const lastSlash = path.lastIndexOf('/');
            if (lastSlash > 0) {
                path = path.substring(0, lastSlash);
            } else {
                path = '/';
            }

            pathInput.value = path;
            browseDirectory();
        }

        async function browseDirectory() {
            const path = document.getElementById('browsePathInput').value || '/';
            const filesResponseArea = document.getElementById('filesResponseArea');
            const serverFiles = document.getElementById('serverFiles');

            filesResponseArea.innerHTML = `<div class="response-header">${t('loadingInfo')} ${esc(path)}...</div>`;

            try {
                const response = await sendCustomRequest('INFO', SERVER_URL + path);
                const text = await response.text();
                const info = JSON.parse(text);

                if (info.is_directory && info.contents) {
                    const basePath = path === '/' ? '' : path;
                    serverFiles.innerHTML = info.contents.map(item => {
                        const itemPath = (basePath + '/' + item.name).replace(/'/g, "\\'").replace(/</g, '&lt;');
                        return `
                        <div class="uploaded-file">
                            <div class="file-info">
                                <span style="font-size: 1.2rem">${item.is_dir ? 'üìÅ' : 'üìÑ'}</span>
                                <span class="file-name">${esc(item.name)}</span>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                ${!item.is_dir ? `
                                    <button class="btn-info btn--sm" onclick="getFileInfo('${itemPath}')">INFO</button>
                                    <button class="btn-fetch btn--sm" onclick="downloadFile('${itemPath}')">FETCH</button>
                                    <button class="btn--sm" onclick="showSmuggleDialog('${itemPath}')" style="background: #8b5cf6; color: #fff; border: none; border-radius: 8px; cursor: pointer;">SMUGGLE</button>
                                ` : `
                                    <button class="btn-info btn--sm" onclick="document.getElementById('browsePathInput').value='${itemPath}'; browseDirectory();">${t('open')}</button>
                                `}
                            </div>
                        </div>
                    `}).join('');
                } else {
                    serverFiles.innerHTML = '';
                }

                const sandboxNote = info.sandbox_mode ? '\n--- ' + t('sandboxMode') + ' ---\n' : '';
                filesResponseArea.innerHTML = `
<div class="response-header">
INFO ${path}
<span class="status success">200 OK</span>${info.sandbox_mode ? ' <span style="color: #f97316;">[SANDBOX]</span>' : ''}
</div>
<div class="response-body">${esc(sandboxNote)}${esc(JSON.stringify(info, null, 2))}</div>`;

            } catch (error) {
                filesResponseArea.innerHTML = `
<div class="response-header">
INFO ${path}
<span class="status error">${t('error')}</span>
</div>
<div class="response-body">${esc(error.message)}</div>`;
            }
        }

        async function getFileInfo(path) {
            document.getElementById('browsePathInput').value = path;
            await browseDirectory();
        }

        // ===== OPSEC Mode =====
        let opsecFile = null;
        const opsecFileInput = document.getElementById('opsecFileInput');
        const opsecUploadBtn = document.getElementById('opsecUploadBtn');
        const opsecDropZone = document.getElementById('opsecDropZone');
        const opsecEncryptCheckbox = document.getElementById('opsecEncrypt');
        const opsecPasswordInput = document.getElementById('opsecPassword');

        // Toggle password field when encryption checkbox changes
        opsecEncryptCheckbox.addEventListener('change', () => {
            opsecPasswordInput.disabled = !opsecEncryptCheckbox.checked;
            if (opsecEncryptCheckbox.checked) {
                opsecPasswordInput.focus();
            }
        });

        // Toggle base64 key checkbox when send key checkbox changes
        const opsecSendKeyCheckbox = document.getElementById('opsecSendKey');
        const opsecKeyBase64Checkbox = document.getElementById('opsecKeyBase64');
        opsecSendKeyCheckbox.addEventListener('change', () => {
            opsecKeyBase64Checkbox.disabled = !opsecSendKeyCheckbox.checked;
            if (!opsecSendKeyCheckbox.checked) {
                opsecKeyBase64Checkbox.checked = false;
            }
        });

        // XOR encryption function - uses UTF-8 encoding for password (matches Python)
        function xorEncrypt(data, password) {
            if (!password) return data;

            // Convert password to UTF-8 bytes (same as Python's .encode('utf-8'))
            const encoder = new TextEncoder();
            const keyBytes = encoder.encode(password);

            // XOR each byte with key
            const result = new Uint8Array(data.length);
            for (let i = 0; i < data.length; i++) {
                result[i] = data[i] ^ keyBytes[i % keyBytes.length];
            }
            return result;
        }

        // Random method names –¥–ª—è OPSEC
        const methodPrefixes = ['CHECK', 'SYNC', 'VERIFY', 'UPDATE', 'QUERY', 'REPORT', 'SUBMIT', 'VALIDATE', 'PROCESS', 'EXECUTE'];
        const methodSuffixes = ['DATA', 'STATUS', 'INFO', 'CONTENT', 'RESOURCE', 'ITEM', 'OBJECT', 'RECORD', 'ENTRY', ''];

        function generateRandomMethod() {
            const prefix = methodPrefixes[Math.floor(Math.random() * methodPrefixes.length)];
            const suffix = methodSuffixes[Math.floor(Math.random() * methodSuffixes.length)];
            const method = suffix ? `${prefix}${suffix}` : prefix;
            document.getElementById('opsecMethodInput').value = method;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã–º –º–µ—Ç–æ–¥–æ–º
        generateRandomMethod();

        opsecFileInput.addEventListener('change', () => {
            if (opsecFileInput.files.length > 0) {
                opsecFile = opsecFileInput.files[0];
                opsecUploadBtn.disabled = false;
                document.getElementById('opsecResponseArea').innerHTML = `
                    <div class="response-header">${esc(t('opsecFileSelected'))}: ${esc(opsecFile.name)} (${formatSize(opsecFile.size)})</div>
                `;
            }
        });

        opsecDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            opsecDropZone.style.borderColor = '#818cf8';
        });

        opsecDropZone.addEventListener('dragleave', () => {
            opsecDropZone.style.borderColor = '#6366f1';
        });

        opsecDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            opsecDropZone.style.borderColor = '#6366f1';
            if (e.dataTransfer.files.length > 0) {
                opsecFile = e.dataTransfer.files[0];
                opsecUploadBtn.disabled = false;
                document.getElementById('opsecResponseArea').innerHTML = `
                    <div class="response-header">${esc(t('opsecFileSelected'))}: ${esc(opsecFile.name)} (${formatSize(opsecFile.size)})</div>
                `;
            }
        });

        async function opsecUpload() {
            if (!opsecFile) return;

            const responseArea = document.getElementById('opsecResponseArea');
            const method = document.getElementById('opsecMethodInput').value || 'SYNCDATA';
            const includeName = document.getElementById('opsecIncludeName').checked;
            const useEncryption = opsecEncryptCheckbox.checked;
            const password = opsecPasswordInput.value;

            // Validate password if encryption is enabled
            if (useEncryption && !password) {
                responseArea.innerHTML = `<div class="response-header"><span class="status error">${esc(t('opsecPasswordRequired'))}</span></div>`;
                return;
            }

            responseArea.innerHTML = `<div class="response-header">${esc(t('opsecUploading'))} ${esc(method)}${useEncryption ? ' (' + esc(t('opsecXorEncryption')) + ')' : ''}...</div>`;
            opsecUploadBtn.disabled = true;

            try {
                const arrayBuffer = await opsecFile.arrayBuffer();
                let dataBytes = new Uint8Array(arrayBuffer);

                // Apply XOR encryption if enabled
                if (useEncryption) {
                    dataBytes = xorEncrypt(dataBytes, password);
                    console.log(`[OPSEC] XOR encryption applied with password length: ${password.length}`);
                }

                let binary = '';
                const chunkSize = 8192;
                for (let i = 0; i < dataBytes.length; i += chunkSize) {
                    binary += String.fromCharCode.apply(null, dataBytes.subarray(i, i + chunkSize));
                }
                const base64Data = btoa(binary);

                // –§–æ—Ä–º–∏—Ä—É–µ–º payload - –∏–º—è —Ñ–∞–π–ª–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ checkbox –≤–∫–ª—é—á–µ–Ω
                const sendKeyToServer = document.getElementById('opsecSendKey').checked;
                const encodeKeyBase64 = document.getElementById('opsecKeyBase64').checked;
                const payload = {
                    d: base64Data
                };
                if (useEncryption) {
                    payload.e = 'xor';
                    if (sendKeyToServer) {
                        if (encodeKeyBase64) {
                            payload.k = btoa(unescape(encodeURIComponent(password)));  // Base64 UTF-8
                            payload.kb64 = true;  // –§–ª–∞–≥ —á—Ç–æ –∫–ª—é—á –≤ base64
                        } else {
                            payload.k = password;  // –ö–ª—é—á –∫–∞–∫ –µ—Å—Ç—å
                        }
                    }
                }
                if (includeName) {
                    payload.n = opsecFile.name;
                }

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø—É—Ç—å (–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞!)
                const randomPath = '/' + Math.random().toString(36).substring(2, 10);

                console.log(`[OPSEC] Method: ${method}, Path: ${randomPath}, Include name: ${includeName}`);

                const response = await sendCustomRequest(method, SERVER_URL + randomPath, JSON.stringify(payload), {
                    'Content-Type': 'application/json'
                });

                const text = await response.text();
                console.log(`[OPSEC] Response:`, text);

                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    result = { ok: false, error: text };
                }

                if (result.ok) {
                    responseArea.innerHTML = `
<div class="response-header">
${esc(method)} ${esc(randomPath)}
<span class="status success">${esc(t('opsecUploaded'))}</span>
</div>
<div class="response-body">--- ${esc(t('opsecSuccess'))} ---
${esc(t('opsecId'))}: ${esc(result.id)}
${esc(t('opsecSize'))}: ${esc(result.sz)} ${esc(t('opsecBytes'))}

${t('methodLabel')} ${esc(method)} ${esc(t('opsecMethodRandom'))}
Path: ${esc(randomPath)} ${esc(t('opsecPathNoName'))}
${esc(t('opsecNameInReq'))}: ${includeName ? esc(t('opsecYes')) : esc(t('opsecNoHidden'))}
${esc(t('opsecEncryption'))}: ${useEncryption ? (sendKeyToServer ? esc(t('opsecXorDecrypted')) + (encodeKeyBase64 ? esc(t('opsecKeyInBase64')) : '') + ')' : esc(t('opsecXorEncrypted'))) : esc(t('opsecNone'))}
</div>`;
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    generateRandomMethod();
                } else {
                    responseArea.innerHTML = `
<div class="response-header">
${esc(method)} ${esc(randomPath)}
<span class="status error">${t('error')}</span>
</div>
<div class="response-body">${esc(result.error || 'Unknown error')}</div>`;
                }
            } catch (error) {
                console.error('[OPSEC] Error:', error);
                responseArea.innerHTML = `
<div class="response-header">
<span class="status error">${t('error')}</span>
</div>
<div class="response-body">${esc(error.message)}</div>`;
            }

            opsecUploadBtn.disabled = false;
        }

        // ===== HTML Smuggling =====
        function showSmuggleDialog(filePath) {
            // Clean up existing modal if any (prevent DOM leak)
            closeSmuggleDialog();
            const modal = document.createElement('div');
            modal.id = 'smuggleModal';
            modal.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="smuggleDialogTitle">
                        <h3 id="smuggleDialogTitle">${t('smuggleTitle')}</h3>
                        <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md); font-size: 0.9rem;">${t('smuggleFile')}: ${esc(filePath)}</p>
                        <div style="margin-bottom: var(--spacing-md);">
                            <label style="color: var(--color-text-muted); font-size: 0.9rem;">
                                <input type="checkbox" id="smuggleEncrypt"> ${t('smuggleProtect')}
                            </label>
                            <p style="color: var(--color-text-dimmed); font-size: 0.8rem; margin-top: var(--spacing-xs);">${t('smuggleProtectHint')}</p>
                        </div>
                        <div class="modal-actions">
                            <button id="smuggleSubmitBtn" style="background: var(--color-violet); color: #fff;">${t('smuggleOpen')}</button>
                            <button id="smuggleCancelBtn" style="background: var(--color-border); color: #fff; font-weight: normal;">${t('smuggleCancel')}</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            document.getElementById('smuggleSubmitBtn').onclick = () => executeSmuggle(filePath);
            document.getElementById('smuggleCancelBtn').onclick = closeSmuggleDialog;

            // Close on Escape or overlay click, focus trap
            modal.querySelector('.modal-overlay').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) closeSmuggleDialog();
            });
            const keyHandler = (e) => {
                if (e.key === 'Escape') { closeSmuggleDialog(); document.removeEventListener('keydown', keyHandler); return; }
                if (e.key === 'Tab') {
                    const focusable = modal.querySelectorAll('input, button');
                    const first = focusable[0], last = focusable[focusable.length - 1];
                    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                }
            };
            document.addEventListener('keydown', keyHandler);

            // Focus the submit button
            document.getElementById('smuggleSubmitBtn').focus();
        }

        function closeSmuggleDialog() {
            const modal = document.getElementById('smuggleModal');
            if (modal) modal.remove();
        }

        async function executeSmuggle(filePath) {
            const usePassword = document.getElementById('smuggleEncrypt').checked;
            closeSmuggleDialog();

            // –§–æ—Ä–º–∏—Ä—É–µ–º URL
            let url = SERVER_URL + filePath;
            if (usePassword) {
                url += '?encrypt=1';  // –°–µ—Ä–≤–µ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–∞—Ä–æ–ª—å
            }

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ HTML —Ñ–∞–π–ª–∞
            try {
                const response = await sendCustomRequest('SMUGGLE', url);
                const text = await response.text();

                if (response.status === 200) {
                    const result = JSON.parse(text);

                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞–ø—Ä—è–º—É—é —Å —Å–µ—Ä–≤–µ—Ä–∞
                    window.open(SERVER_URL + result.url, '_blank');

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    const filesResponseArea = document.getElementById('filesResponseArea');
                    filesResponseArea.innerHTML = `
<div class="response-header">
SMUGGLE ${esc(filePath)}
<span class="status success">${t('smuggleGenerated')}</span>
</div>
<div class="response-body">${t('smuggleFile')}: ${esc(result.file)}
${t('smuggleEncrypted')}: ${result.encrypted ? t('smuggleYes') : t('smuggleNo')}
URL: ${esc(result.url)}

${t('smuggleOpened')}</div>`;
                } else {
                    const filesResponseArea = document.getElementById('filesResponseArea');
                    filesResponseArea.innerHTML = `<div class="response-header">SMUGGLE ${esc(filePath)} <span class="status error">${t('error')}</span></div><div class="response-body">${esc(text)}</div>`;
                }
            } catch (error) {
                const filesResponseArea = document.getElementById('filesResponseArea');
                filesResponseArea.innerHTML = `<div class="response-header">SMUGGLE ${esc(filePath)} <span class="status error">${t('error')}</span></div><div class="response-body">${esc(error.message)}</div>`;
            }
        }
        // ===== Secure Notepad v2 (ECDH + WebSocket) =====
        let notepadCurrentId = null;
        let notepadAutoSaveTimer = null;
        let notepadSessionId = null;
        let notepadDerivedKey = null;   // CryptoKey for AES-GCM
        let notepadHasEcdh = false;
        let notepadInitDone = false;
        let notepadWs = null;

        const NOTEPAD_HTTP_DELAY = 500;
        const NOTEPAD_WS_DELAY = 300;

        const notepadTitleInput = document.getElementById('notepadTitleInput');
        const notepadTextarea = document.getElementById('notepadTextarea');
        const notepadSaveIndicator = document.getElementById('notepadSaveIndicator');
        const notepadCharCount = document.getElementById('notepadCharCount');
        const notepadDeleteBtnEl = document.getElementById('notepadDeleteBtn');
        const notepadConnStatus = document.getElementById('notepadConnStatus');

        function notepadGetTransport() {
            const el = document.querySelector('input[name="notepadTransport"]:checked');
            return el ? el.value : 'http';
        }

        function notepadGetDelay() {
            return notepadGetTransport() === 'ws' ? NOTEPAD_WS_DELAY : NOTEPAD_HTTP_DELAY;
        }

        // Transport toggle handlers
        document.querySelectorAll('input[name="notepadTransport"]').forEach(el => {
            el.addEventListener('change', () => {
                if (el.value === 'ws' && el.checked) {
                    notepadConnectWs();
                } else if (el.value === 'http' && el.checked) {
                    notepadDisconnectWs();
                }
            });
        });

        // Auto-save on textarea input
        notepadTextarea.addEventListener('input', () => {
            notepadCharCount.textContent = notepadTextarea.value.length + ' chars';
            notepadScheduleAutoSave();
        });

        // Auto-save on title input
        notepadTitleInput.addEventListener('input', () => {
            notepadScheduleAutoSave();
        });

        function notepadScheduleAutoSave() {
            if (!notepadInitDone) return;
            notepadSetStatus('unsaved');
            clearTimeout(notepadAutoSaveTimer);
            notepadAutoSaveTimer = setTimeout(notepadSave, notepadGetDelay());
        }

        function notepadSetStatus(state) {
            const stateMap = {
                'connecting': { class: '', text: t('notepadConnecting') },
                'connected': { class: 'saved', text: t('notepadConnected') },
                'disconnected': { class: 'error', text: t('notepadDisconnected') },
                'ready': { class: '', text: t('notepadReady') },
                'unsaved': { class: 'unsaved', text: t('notepadUnsaved') },
                'saving': { class: 'saving', text: t('notepadSaving') },
                'saved': { class: 'saved', text: t('notepadSaved') },
                'error': { class: 'error', text: t('notepadSaveError') },
                'loading': { class: 'saving', text: t('notepadLoading') },
                'loaded': { class: 'saved', text: t('notepadLoaded') },
                'loadError': { class: 'error', text: t('notepadLoadError') },
                'decryptError': { class: 'error', text: t('notepadDecryptError') },
                'sessionFailed': { class: 'error', text: t('notepadSessionFailed') },
                'noEncryption': { class: '', text: t('notepadNoEncryption') },
            };
            const s = stateMap[state] || { class: '', text: state };
            notepadSaveIndicator.className = 'save-indicator ' + s.class;
            notepadSaveIndicator.textContent = s.text;
        }

        function notepadSetConnStatus(cls, title) {
            notepadConnStatus.className = 'notepad-connection-status ' + cls;
            notepadConnStatus.title = title;
        }

        // ‚îÄ‚îÄ Base64 helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function uint8ToBase64(bytes) {
            const chunks = [];
            const chunkSize = 8192;
            for (let i = 0; i < bytes.length; i += chunkSize) {
                chunks.push(String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize)));
            }
            return btoa(chunks.join(''));
        }

        function base64ToUint8(b64) {
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes;
        }

        // ‚îÄ‚îÄ ECDH Session Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function notepadInit() {
            if (notepadInitDone) {
                notepadRefreshList();
                return;
            }
            notepadSetStatus('connecting');
            notepadSetConnStatus('connecting', t('notepadConnecting'));

            try {
                await notepadInitSession();
                notepadInitDone = true;
                notepadTitleInput.disabled = false;
                notepadTextarea.disabled = false;
                if (notepadHasEcdh) {
                    notepadSetStatus('connected');
                    notepadSetConnStatus('connected', t('notepadConnected'));
                } else {
                    notepadSetStatus('noEncryption');
                    notepadSetConnStatus('no-encryption', t('notepadNoEncryption'));
                }
                notepadRefreshList();
            } catch (e) {
                console.error('[Notepad] Session init failed:', e);
                // Fall back to unencrypted mode
                notepadInitDone = true;
                notepadHasEcdh = false;
                notepadTitleInput.disabled = false;
                notepadTextarea.disabled = false;
                notepadSetStatus('noEncryption');
                notepadSetConnStatus('no-encryption', t('notepadNoEncryption'));
                notepadRefreshList();
            }
        }

        async function notepadInitSession() {
            // 1. Get server public key
            const keyResp = await sendCustomRequest('NOTE', SERVER_URL + '/notes/key');
            const keyText = await keyResp.text();
            const keyData = JSON.parse(keyText);

            if (!keyData.hasEcdh) {
                notepadHasEcdh = false;
                return;
            }

            // 2. Generate client ECDH key pair
            const clientKeyPair = await crypto.subtle.generateKey(
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                ['deriveBits']
            );

            // 3. Exchange keys
            const clientPubRaw = await crypto.subtle.exportKey('raw', clientKeyPair.publicKey);
            const clientPubB64 = uint8ToBase64(new Uint8Array(clientPubRaw));

            const exchangeResp = await sendCustomRequest('NOTE', SERVER_URL + '/notes/exchange',
                JSON.stringify({ clientPublicKey: clientPubB64 }),
                { 'Content-Type': 'application/json' }
            );
            const exchangeText = await exchangeResp.text();
            const exchangeData = JSON.parse(exchangeText);
            notepadSessionId = exchangeData.sessionId;

            // 4. Import server public key
            const serverPubRaw = base64ToUint8(exchangeData.serverPublicKey);
            const serverPubKey = await crypto.subtle.importKey(
                'raw', serverPubRaw,
                { name: 'ECDH', namedCurve: 'P-256' },
                false,
                []
            );

            // 5. Derive shared bits
            const sharedBits = await crypto.subtle.deriveBits(
                { name: 'ECDH', public: serverPubKey },
                clientKeyPair.privateKey,
                256
            );

            // 6. HKDF to get AES-256 key
            const sharedKeyMaterial = await crypto.subtle.importKey(
                'raw', sharedBits, 'HKDF', false, ['deriveKey']
            );

            notepadDerivedKey = await crypto.subtle.deriveKey(
                {
                    name: 'HKDF',
                    hash: 'SHA-256',
                    salt: new Uint8Array(32),  // 32 zero bytes
                    info: new TextEncoder().encode('notepad-e2e-key'),
                },
                sharedKeyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );

            notepadHasEcdh = true;
        }

        // ‚îÄ‚îÄ ECDH encrypt/decrypt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function notepadEncrypt(text) {
            const enc = new TextEncoder();
            const plaintext = enc.encode(text);
            const nonce = crypto.getRandomValues(new Uint8Array(12));
            const ciphertext = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: nonce },
                notepadDerivedKey,
                plaintext
            );
            // Wire format: nonce(12) + ciphertext + tag(16)
            const result = new Uint8Array(12 + ciphertext.byteLength);
            result.set(nonce, 0);
            result.set(new Uint8Array(ciphertext), 12);
            return result;
        }

        async function notepadDecrypt(encryptedBytes) {
            if (encryptedBytes.length < 12 + 16) throw new Error('Data too short');
            const nonce = encryptedBytes.slice(0, 12);
            const ciphertext = encryptedBytes.slice(12);
            const plaintext = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: nonce },
                notepadDerivedKey,
                ciphertext
            );
            return new TextDecoder().decode(plaintext);
        }

        // ‚îÄ‚îÄ WebSocket client ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function notepadConnectWs() {
            notepadDisconnectWs();
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            notepadWs = new WebSocket(proto + '//' + location.host + '/notes/ws');
            notepadSetConnStatus('connecting', t('notepadConnecting'));

            notepadWs.onopen = () => {
                notepadSetConnStatus('connected', notepadHasEcdh ? t('notepadConnected') : t('notepadNoEncryption'));
            };

            notepadWs.onmessage = (evt) => {
                try {
                    const msg = JSON.parse(evt.data);
                    notepadHandleWsMessage(msg);
                } catch (e) {
                    console.error('[Notepad WS] Parse error:', e);
                }
            };

            notepadWs.onclose = () => {
                // Only show "disconnected" if we didn't intentionally switch to HTTP
                const wasIntentional = notepadGetTransport() === 'http';
                notepadWs = null;
                if (!wasIntentional) {
                    notepadSetConnStatus('disconnected', t('notepadDisconnected'));
                }
            };

            notepadWs.onerror = () => {
                if (notepadGetTransport() !== 'http') {
                    notepadSetConnStatus('disconnected', t('notepadDisconnected'));
                }
            };
        }

        function notepadDisconnectWs() {
            if (notepadWs) {
                notepadWs.close();
                notepadWs = null;
            }
            notepadSetConnStatus(
                notepadHasEcdh ? 'connected' : 'no-encryption',
                notepadHasEcdh ? t('notepadConnected') : t('notepadNoEncryption')
            );
        }

        function notepadSendWs(msg) {
            if (notepadWs && notepadWs.readyState === WebSocket.OPEN) {
                notepadWs.send(JSON.stringify(msg));
            }
        }

        function notepadHandleWsMessage(msg) {
            if (msg.type === 'saved') {
                if (msg.success) {
                    if (!notepadCurrentId) notepadCurrentId = msg.id;
                    notepadDeleteBtnEl.disabled = false;
                    notepadSetStatus('saved');
                    notepadRefreshList();
                } else {
                    notepadSetStatus('error');
                }
            } else if (msg.type === 'loaded') {
                notepadHandleLoadResult(msg);
            } else if (msg.type === 'list') {
                notepadRenderList(msg.notes || []);
            } else if (msg.type === 'deleted') {
                notepadNewNote();
            } else if (msg.type === 'error') {
                console.error('[Notepad WS] Server error:', msg.error);
                notepadSetStatus('error');
            }
        }

        // ‚îÄ‚îÄ CRUD operations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function notepadSave() {
            const text = notepadTextarea.value;
            const title = notepadTitleInput.value.trim() || t('notepadUntitled');

            if (!text && !notepadCurrentId) return;

            notepadSetStatus('saving');

            try {
                let dataB64;
                if (notepadHasEcdh && notepadDerivedKey) {
                    const encrypted = await notepadEncrypt(text);
                    dataB64 = uint8ToBase64(encrypted);
                } else {
                    // Fallback: send plaintext as base64
                    dataB64 = btoa(unescape(encodeURIComponent(text)));
                }

                if (notepadGetTransport() === 'ws' && notepadWs && notepadWs.readyState === WebSocket.OPEN) {
                    // WebSocket save
                    notepadSendWs({
                        type: 'save',
                        sessionId: notepadSessionId || '',
                        noteId: notepadCurrentId || '',
                        title: title,
                        data: dataB64,
                    });
                } else {
                    // HTTP save
                    const payload = { title: title, data: dataB64 };
                    if (notepadCurrentId) payload.id = notepadCurrentId;

                    const headers = { 'Content-Type': 'application/json' };
                    if (notepadSessionId) headers['X-Session-Id'] = notepadSessionId;

                    const response = await sendCustomRequest('NOTE', SERVER_URL + '/notes', JSON.stringify(payload), headers);
                    const respText = await response.text();
                    const result = JSON.parse(respText);

                    if (result.success) {
                        if (!notepadCurrentId) notepadCurrentId = result.id;
                        notepadDeleteBtnEl.disabled = false;
                        notepadSetStatus('saved');
                        notepadRefreshList();
                    } else {
                        notepadSetStatus('error');
                    }
                }
            } catch (e) {
                console.error('[Notepad] Save error:', e);
                notepadSetStatus('error');
            }
        }

        async function notepadRefreshList() {
            if (notepadGetTransport() === 'ws' && notepadWs && notepadWs.readyState === WebSocket.OPEN) {
                notepadSendWs({ type: 'list' });
                return;
            }

            try {
                const response = await sendCustomRequest('NOTE', SERVER_URL + '/notes?list');
                const text = await response.text();
                const result = JSON.parse(text);
                notepadRenderList(result.notes || []);
            } catch (e) {
                console.error('[Notepad] List error:', e);
            }
        }

        function notepadRenderList(notes) {
            const listEl = document.getElementById('notepadNoteList');
            if (!notes || notes.length === 0) {
                listEl.innerHTML = '<div class="notepad-no-notes">' + esc(t('notepadNoNotes')) + '</div>';
                return;
            }

            listEl.innerHTML = notes.map(note => {
                const isActive = note.id === notepadCurrentId;
                const date = note.updated_at ? new Date(note.updated_at).toLocaleString() : '';
                return '<div class="note-item' + (isActive ? ' active' : '') + '" onclick="notepadLoadNote(\'' + esc(note.id) + '\')">' +
                    '<div class="note-item-title">' + esc(note.title || t('notepadUntitled')) + '</div>' +
                    '<div class="note-item-date">' + esc(date) + '</div>' +
                    '</div>';
            }).join('');
        }

        async function notepadLoadNote(id) {
            notepadSetStatus('loading');

            try {
                const response = await sendCustomRequest('NOTE', SERVER_URL + '/notes/' + id);
                const text = await response.text();
                const result = JSON.parse(text);

                if (response.status === 404) {
                    notepadSetStatus('loadError');
                    return;
                }

                await notepadHandleLoadResult(result);
            } catch (e) {
                console.error('[Notepad] Load error:', e);
                notepadSetStatus('loadError');
            }
        }

        async function notepadHandleLoadResult(result) {
            try {
                const encryptedBytes = base64ToUint8(result.data);
                let plaintext;

                if (notepadHasEcdh && notepadDerivedKey) {
                    plaintext = await notepadDecrypt(encryptedBytes);
                } else {
                    // Fallback: treat as plaintext base64
                    plaintext = decodeURIComponent(escape(atob(result.data)));
                }

                notepadCurrentId = result.id;
                notepadTitleInput.value = result.title || '';
                notepadTextarea.value = plaintext;
                notepadCharCount.textContent = plaintext.length + ' chars';
                notepadDeleteBtnEl.disabled = false;
                notepadSetStatus('loaded');
                notepadRefreshList();
            } catch (e) {
                console.error('[Notepad] Decrypt/load error:', e);
                if (e.name === 'OperationError' || (e.message && e.message.includes('decrypt'))) {
                    notepadSetStatus('decryptError');
                } else {
                    notepadSetStatus('loadError');
                }
            }
        }

        function notepadNewNote() {
            notepadCurrentId = null;
            notepadTitleInput.value = '';
            notepadTextarea.value = '';
            notepadCharCount.textContent = '0 chars';
            notepadDeleteBtnEl.disabled = true;
            clearTimeout(notepadAutoSaveTimer);
            if (notepadInitDone) {
                notepadSetStatus('ready');
                notepadTitleInput.focus();
            } else {
                notepadSetStatus('connecting');
            }
            notepadRefreshList();
        }

        async function notepadDeleteNote() {
            if (!notepadCurrentId) return;
            if (!confirm(t('notepadDeleteConfirm'))) return;

            try {
                if (notepadGetTransport() === 'ws' && notepadWs && notepadWs.readyState === WebSocket.OPEN) {
                    notepadSendWs({ type: 'delete', id: notepadCurrentId });
                } else {
                    await sendCustomRequest('NOTE', SERVER_URL + '/notes/' + notepadCurrentId + '?delete');
                    notepadNewNote();
                }
            } catch (e) {
                console.error('[Notepad] Delete error:', e);
            }
        }
    </script>
</body>
</html>
